<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Shopping Cart - EcomStore</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <%- include('partials/header') %>
  
  <main class="cart-page">
    <div class="container">
      <h1>Shopping Cart</h1>
      
      <% if (!cart.items || cart.items.length === 0) { %>
        <div class="empty-state">
          <p>Your cart is empty</p>
          <a href="/" class="btn btn-primary">Continue Shopping</a>
        </div>
      <% } else { %>
        <div class="cart-container">
          <div class="cart-items">
            <% cart.items.forEach(item => { %>
              <div class="cart-item" data-product-id="<%= item.productId %>">
                <img src="<%= item.imageUrl %>" alt="<%= item.productName %>">
                <div class="cart-item-details">
                  <h3><%= item.productName %></h3>
                  <p class="cart-item-price">$<%= item.price.toFixed(2) %></p>
                </div>
                <div class="cart-item-quantity">
                  <button onclick="updateQuantity('<%= item.productId %>', <%= item.quantity - 1 %>)" class="qty-btn">-</button>
                  <input type="number" value="<%= item.quantity %>" min="1" readonly>
                  <button onclick="updateQuantity('<%= item.productId %>', <%= item.quantity + 1 %>)" class="qty-btn">+</button>
                </div>
                <div class="cart-item-total">
                  <p>$<%= (item.price * item.quantity).toFixed(2) %></p>
                </div>
                <button onclick="removeFromCart('<%= item.productId %>')" class="btn-remove">Ã—</button>
              </div>
            <% }) %>
          </div>
          
          <div class="cart-summary">
            <h2>Order Summary</h2>
            <div class="summary-row">
              <span>Subtotal:</span>
              <span id="cart-total">$<%= total.toFixed(2) %></span>
            </div>
            <div class="summary-row">
              <span>Shipping:</span>
              <span>Free</span>
            </div>
            <div class="summary-row total">
              <span>Total:</span>
              <span id="cart-final-total">$<%= total.toFixed(2) %></span>
            </div>
            <button onclick="checkout()" class="btn btn-primary btn-checkout">Proceed to Checkout</button>
            <a href="/" class="btn btn-secondary">Continue Shopping</a>
          </div>
        </div>
      <% } %>
    </div>
  </main>
  
  <%- include('partials/footer') %>
  
  <script>
    async function updateQuantity(productId, quantity) {
      if (quantity < 1) return;
      
      try {
        const response = await fetch('/cart/update', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ productId, quantity })
        });
        
        const data = await response.json();
        if (data.success) {
          location.reload();
        }
      } catch (error) {
        alert('Failed to update quantity');
      }
    }
    
    async function removeFromCart(productId) {
      if (!confirm('Remove this item from cart?')) return;
      
      try {
        const response = await fetch('/cart/remove', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ productId })
        });
        
        const data = await response.json();
        if (data.success) {
          location.reload();
        }
      } catch (error) {
        alert('Failed to remove item');
      }
    }
    
    async function checkout() {
      try {
        const response = await fetch('/cart/checkout', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        
        const data = await response.json();
        if (data.success) {
          alert(data.message);
          window.location.href = '/my-orders';
        } else {
          alert('Error: ' + data.error);
        }
      } catch (error) {
        alert('Failed to complete checkout');
      }
    }
  </script>
</body>
</html>
